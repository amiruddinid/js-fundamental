# SQL

# DDL - DATA DEFINITION LANGUAGE
## Membuat database
CREATE DATABASE <nama_database>;

## List database
\l

## connect ke database
\c <nama_database>

## Membuat table
CREATE TABLE <nama_table> (
    <nama_kolom> <tipe_data> <attribut>
)

## Contoh :
CREATE TABLE users(
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(255) NOT NULL,
    email VARCHAR(255) NOT NULL,
    password VARCHAR(255) NOT NULL,
    profile TEXT,
    verified BOOLEAN NOT NULL DEFAULT FALSE
);

# notes

# BIGSERIAL = untuk autoincrement akan otomatis membuat data / value unik setiap menambahkan data
# PRIMARY KEY = menandai kolom yang menjadi primary KEY
# VARCHAR(n) = tipe data text yang di batasi jumlah character nya 1 - 255
# NOT NULL = atribut yang menandai table tidak boleh di isi data kosong
# TEXT = tipe data text yang tidak di batasi jumlah characternya
# BOOLEAN = tipe data BOOLEAN
# DEFAULT <value> = untuk menentukan default value / nilai kolom

# menampilkan list table 
\dt

# ganti nama database
# syarat : tidak boleh menganti nama database yang sedang digunakan / connect
ALTER DATABASE <nama_database_lama> RENAME TO <nama_database_baru>

# ganti nama table
ALTER TABLE <nama_table_lama> RENAME TO <nama_table_baru>;

# menambahkan kolom baru
ALTER TABLE users
ADD COLUMN media VARCHAR;

# melihat detail struktur table
\d+ <nama_table>

# !dangerous section!
# menghapus table
DROP TABLE <nama_table>
DROP DATABASE <nama_database>

# DML - DATA MANIPULATION LANGUAGE
## Menambahkan data
# note : untuk value string menggunakan petik 1
INSERT INTO <nama_table>(column1, column2)
VALUES ('value1', 'value2')

## Menampilkan data yang dan menampilkan semua kolom
SELECT * FROM <nama_table>

## Menampilkan data yang dan menampilkan kolom yang dipilih
SELECT column1, column2 FROM <nama_table>

## Keyword Where untuk menampilkan data dengan kondisi
SELECT <column> FROM users WHERE <kondisi>

## Keyword Where dan like untuk mencari data dengan pattern
SELECT <column> FROM users WHERE <kondisi>

## Update

UPDATE <nama_table>
SET
 column1 = 'value',
 column2 = 'value'
WHERE kondisi 

## DELETE

DELETE FROM <nama_table> WHERE <kondisi>;

#note : lebih baik mengunakan primary key sebagai kondisi untuk memilih data

## STORED PROCEDURE
# sama dengan sebuah void function (yang tidak menghasilkan atau return data) 
  di pemograman yang menyimpan procedure ke database dan akan menerima parameter
# bisa di panggil ketika di butuhkan meskipun terminal tertutup karena sudah tersimpan di database

#buat table akun
drop table if exists akun;

create table akun (
    id int generated by default as identity,
    name varchar(100) not null,
    balance dec(15, 2) not null,
    primary key(id)
);

insert into akun(name, balance)
values('Andi', 100000);

insert into akun(name, balance)
values('Budi', 100000);

#membuat procedure transfer
CREATE OR REPLACE PROCEDURE transfer(
   sender INT,
   receiver INT, 
   amount DEC
)
LANGUAGE sql    
AS $$
BEGIN
    -- subtracting the amount from the sender's account 
    UPDATE akun 
    SET 
        balance = balance - amount,
        transaction = transaction + 1
    WHERE id = sender;

    -- adding the amount to the receiver's account
    UPDATE akun 
    SET 
        balance = balance + amount,
        transaction = transaction + 1
    WHERE id = receiver;

    COMMIT;
END;
$$;

#memanggil procedure transfer
CALL transfer(1, 2, 5000)

#referensi : https://www.postgresql.org/docs/current/sql-createprocedure.html
#apa itu $$: https://stackoverflow.com/questions/12144284/what-are-used-for-in-pl-pgsql/12172353#12172353

#procedure transfer sama seperti :
function transfer(pengirim, penerima, nominal){
    akun[pengirim] = akun[pengirim].saldo - nominal
    akun[penerima] = akun[penerima].saldo + nominal
}
transfer(1, 2, 5000)

#Common Table Expression
# harus ditulis dari with sampai Select * from <nama cte>

WITH richMan AS (
    SELECT name, balance
    FROM akun
    WHERE balance > 100000
);
SELECT *
FROM richMan;

#PAGINATION
# LIMIT = akan membatasi data yang muncul
# OFFSET = akan menentukan dari mana kita mulai melakukan pengambilan data.

SELECT * FROM <nama_table>
LIMIT <limit> OFFSET <offset>;

#SORTING
# ORDER BY = akan mengurutkan data berdasarkan kolom 
# ASC = mengurutkan data dari bawah ke atas
# DESC = mengurutkan data dari atas ke bawah

SELECT * FROM <nama_table>
ORDER BY <nama_kolom> ASC / DESC
LIMIT <limit> OFFSET <offset>;

#Total data
# Count(*) = menghitung jumlah data / baris dalam table
SELECT count(*) from <nama_table>

# Tugas
1. Coba tambahkan 20 data ke table yang temen2 punya

## SELECT GROUP BY PAGINATION
## GROUP BY = query untuk melakukan grouping pada data

SELECT nama, SUM(saldo) 
FROM akun 
GROUP BY nama 
ORDER BY nama ASC 
LIMIT 10 OFFSET 0;

## Menghitung data setelah group by
WITH total AS( 
    SELECT nama 
    from akun 
    group by nama 
) 
SELECT count(nama) from total;
#OR
SELECT count(nama) from ( 
    SELECT nama 
    from akun 
    group by nama 
);

#Indexing untuk performa db
select * from akun where nama = 'Aaren';
#membuat index
CREATE INDEX <nama_index> ON <nama_table> (<nama_kolom>);
#menghapus index
DROP INDEX idx_akun_nama;

#Mendefinisikan foreign key di schema table
#saat table sudah ada atau selesai dibuat

#ALTER
ALTER TABLE <nama_table>
 ADD CONSTRAINT fk_<nama_table>_<nama_table_referensi>
 FOREIGN KEY(<nama_kolom_foreign_key>)
 REFERENCES <nama_table_referensi>(<nama_kolom>)

Contoh : 
ALTER TABLE posts
 ADD CONSTRAINT fk_posts_users
 FOREIGN KEY(user_id)
 REFERENCES users(id);

#ketika membuat table

contoh:
CREATE TABLE likes(
  id BIGSERIAL PRIMARY KEY,
  user_id INT,
  post_id INT,
  CONSTRAINT fk_likes_users 
    FOREIGN KEY(user_id) 
    REFERENCES users(id),
  CONSTRAINT fk_likes_posts 
    FOREIGN KEY(post_id) 
    REFERENCES posts(id)
);

#or

CREATE TABLE likes(
  id BIGSERIAL PRIMARY KEY,
  user_id INT FOREIGN KEY REFERENCES users(id),
  post_id INT FOREIGN KEY REFERENCES posts(id)
);

#menambahkan primary key pada table
ALTER TABLE posts
 ADD CONSTRAINT pk_posts
 PRIMARY KEY(id)

ALTER TABLE comments
 ADD CONSTRAINT pk_comments
 PRIMARY KEY(id),
 ADD CONSTRAINT fk_comments_users
 FOREIGN KEY(user_id)
 REFERENCES users(id),
 ADD CONSTRAINT fk_comments_posts
 FOREIGN KEY(post_id)
 REFERENCES posts(id);

# RELATION
# untuk mengabungkan dua table kita bisa mengunakan JOIN

# contoh:
SELECT posts.title, users.name FROM posts
JOIN users ON posts.user_id = users.id;

SELECT count(posts.title) as jumlah_post, users.name FROM posts
JOIN users ON posts.user_id = users.id
WHERE posts.status = 'publish'
GROUP BY users.name;

SOAL : tuliskan query untuk menampilkan users yang belum pernah post